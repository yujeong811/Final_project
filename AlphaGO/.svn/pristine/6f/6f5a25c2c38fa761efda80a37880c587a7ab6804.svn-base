package kr.or.ddit.controller.view;

import java.sql.SQLException;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import kr.or.ddit.dto.MemberVO;
import kr.or.ddit.dto.StudyPlanVO;
import kr.or.ddit.dto.StudyPlanerVO;
import kr.or.ddit.service.StudyPlanService;

@Controller
@RequestMapping("/studyplan")
public class StudyplanController {

	private static final Logger logger = LoggerFactory.getLogger(StudyplanController.class);

	@Autowired
	private StudyPlanService studyplanService;


	@RequestMapping("/list")
	public String list(@RequestParam(defaultValue = "now")String date, HttpSession session, Model model) throws SQLException {
		String url = "studyplan/list";

		if(date.equals("now")) {
			LocalDate now = LocalDate.now();
			DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy.MM.dd");
			date = now.format(formatter);
		}

		MemberVO member = (MemberVO) session.getAttribute("loginUser");

		//계획코드 가져오기
		int spCode = studyplanService.getSpCode(date, member.getId());
		StudyPlanerVO planer = studyplanService.getStudyPlaner(spCode);

		List<StudyPlanVO> planList = studyplanService.getPlanList(spCode);


		model.addAttribute("date", date);
		model.addAttribute("planer", planer);
		model.addAttribute("planList", planList);
		return url;
	}


	@RequestMapping("/modifyForm")
	public String modifyForm(HttpServletRequest request, Model model) throws SQLException {
		String url = "studyplan/modify";

		HttpSession session = request.getSession();
		MemberVO member = (MemberVO) session.getAttribute("loginUser");

		//계획코드 가져오기
		int spCode = studyplanService.getSpCode(request.getParameter("date"), member.getId());
		StudyPlanerVO planer = studyplanService.getStudyPlaner(spCode);

		List<StudyPlanVO> planList = studyplanService.getPlanList(spCode);

		model.addAttribute("planer", planer);
		model.addAttribute("planList", planList);
		model.addAttribute("date", request.getParameter("date"));

		return url;
	}

	@RequestMapping("/modify")
	public String modify(HttpServletRequest request, Model model) throws SQLException {
		String url = "redirect:list.go";


		HttpSession session = request.getSession();
		MemberVO member = (MemberVO) session.getAttribute("loginUser");

		int spCode = studyplanService.getSpCode(request.getParameter("date"), member.getId());
		StudyPlanerVO planer = studyplanService.getStudyPlaner(spCode);

		planer.setStudyTime(Integer.parseInt(request.getParameter("study_time")));
		planer.setFeedback(request.getParameter("feedback"));
//		planer.setAchieveRate();

		studyplanService.updatePlaner(planer);



		for(int i = 0; i < 5; i++) {
			String status = request.getParameter(i + "status");
			String subject_code = request.getParameter(i + "s");
			String study_plan = request.getParameter(i + "p");
			String study_result = request.getParameter(i + "chk");
			String planCode = request.getParameter(i + "code");

			//plan 항목 수정
			if(subject_code != null && study_plan != null && study_result != null ) {
				StudyPlanVO stp = new StudyPlanVO();
				stp.setSpCode(spCode);
				stp.setStudyPlan(study_plan);
				stp.setSubjectCode(Integer.parseInt(subject_code));
				stp.setStudyResult(
					study_result.equals("false") ? 0 : 1
				);
				logger.info(i + "번째 : " + stp );


				if(status != null && status.equals("insert")) {  //insert
					int max = studyplanService.getMaxPlanCode();
					stp.setPlanCode(max);
					studyplanService.insertPlan(stp);
				}else if(status != null && status.equals("update")) {	//update
					stp.setPlanCode(Integer.parseInt(planCode));
					studyplanService.updatePlan(stp);
				}



			}
		}

		return url;
	}

	@RequestMapping("/calendar")
	public String CalendarTest() {
		String url = "studyplan/calendar";
		return url;
	}


	@RequestMapping(value = "/delete", method = RequestMethod.POST)
	@ResponseBody
	public void delete(int planCode) throws SQLException{
		logger.info("planCode : " + planCode );
		studyplanService.deletePlan(planCode);
	}

	@RequestMapping(value = "/check", method = RequestMethod.POST)
	@ResponseBody
	public void check(int code) throws SQLException{
		logger.info("code : " + code );
		studyplanService.checkPlan(code);
	}


}
